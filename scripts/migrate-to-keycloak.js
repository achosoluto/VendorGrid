#!/usr/bin/env node

/**
 * Phase 3: Keycloak Authentication Migration Script
 * 
 * This script facilitates the migration from mock authentication to Keycloak
 * while providing rollback capability and validation.
 * 
 * Usage:
 *   node scripts/migrate-to-keycloak.js [command]
 * 
 * Commands:
 *   status     - Check current authentication status
 *   validate   - Validate Keycloak configuration
 *   migrate    - Migrate to Keycloak authentication
 *   rollback   - Rollback to mock authentication
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { execSync } from 'child_process';

// Get __dirname equivalent in ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Color codes for console output
const colors = {
  green: '\x1b[32m',
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  reset: '\x1b[0m'
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function logSection(title) {
  console.log('\n' + '='.repeat(60));
  log(title, 'blue');
  console.log('='.repeat(60));
}

function getEnvPath() {
  return path.join(__dirname, '..', '.env');
}

function readEnv() {
  const envPath = getEnvPath();
  if (!fs.existsSync(envPath)) {
    return {};
  }
  
  const content = fs.readFileSync(envPath, 'utf8');
  const env = {};
  
  content.split('\n').forEach(line => {
    const trimmed = line.trim();
    if (trimmed && !trimmed.startsWith('#')) {
      const [key, ...valueParts] = trimmed.split('=');
      if (key) {
        env[key.trim()] = valueParts.join('=').trim();
      }
    }
  });
  
  return env;
}

function writeEnv(env) {
  const envPath = getEnvPath();
  const lines = [];
  
  // Write header
  lines.push('# VendorGrid Environment Configuration');
  lines.push('# Generated by Phase 3 Keycloak Migration Script');
  lines.push('');
  
  // Write variables
  Object.keys(env).forEach(key => {
    lines.push(`${key}=${env[key]}`);
  });
  
  fs.writeFileSync(envPath, lines.join('\n') + '\n');
  log('‚úÖ Environment file updated', 'green');
}

function getCurrentAuthProvider() {
  const env = readEnv();
  return env.AUTH_PROVIDER || 'mock';
}

function setAuthProvider(provider) {
  const env = readEnv();
  env.AUTH_PROVIDER = provider;
  writeEnv(env);
  log(`üîê Authentication provider set to: ${provider.toUpperCase()}`, 'blue');
}

async function checkKeycloakStatus() {
  try {
    const baseUrl = process.env.KEYCLOAK_BASE_URL || 'http://localhost:8080';
    const realm = process.env.KEYCLOAK_REALM || 'vendorgrid';
    
    log('üåê Checking Keycloak connectivity...', 'blue');
    
    // Check if Keycloak is accessible
    const response = await fetch(`${baseUrl}/realms/${realm}`);
    if (response.ok) {
      log('‚úÖ Keycloak is accessible', 'green');
      return true;
    } else {
      log(`‚ùå Keycloak returned status: ${response.status}`, 'red');
      return false;
    }
  } catch (error) {
    log(`‚ùå Keycloak connection failed: ${error.message}`, 'red');
    return false;
  }
}

function checkRequiredEnvironmentVariables() {
  const env = readEnv();
  const required = [
    'KEYCLOAK_BASE_URL',
    'KEYCLOAK_REALM', 
    'KEYCLOAK_CLIENT_ID',
    'KEYCLOAK_CLIENT_SECRET'
  ];
  
  const missing = required.filter(key => !env[key] || env[key].startsWith('REPLACE_WITH'));
  
  if (missing.length === 0) {
    log('‚úÖ All required Keycloak environment variables are configured', 'green');
    return true;
  } else {
    log(`‚ùå Missing Keycloak environment variables: ${missing.join(', ')}`, 'red');
    return false;
  }
}

function createEnvironmentBackup() {
  const envPath = getEnvPath();
  const backupPath = envPath + '.backup-' + Date.now();
  
  if (fs.existsSync(envPath)) {
    fs.copyFileSync(envPath, backupPath);
    log(`üìÅ Environment backup created: ${backupPath}`, 'blue');
    return backupPath;
  } else {
    log('‚ö†Ô∏è  No .env file found to backup', 'yellow');
    return null;
  }
}

function showStatus() {
  logSection('Authentication Status Check');
  
  const currentProvider = getCurrentAuthProvider();
  log(`Current Authentication Provider: ${currentProvider.toUpperCase()}`, currentProvider === 'keycloak' ? 'green' : 'yellow');
  
  const env = readEnv();
  
  if (currentProvider === 'keycloak') {
    log('\nKeycloak Configuration:', 'blue');
    log(`  Base URL: ${env.KEYCLOAK_BASE_URL || 'Not configured'}`, 'reset');
    log(`  Realm: ${env.KEYCLOAK_REALM || 'Not configured'}`, 'reset');
    log(`  Client ID: ${env.KEYCLOAK_CLIENT_ID || 'Not configured'}`, 'reset');
    log(`  Client Secret: ${env.KEYCLOAK_CLIENT_SECRET ? 'Configured' : 'Not configured'}`, 'reset');
    
    const allConfigured = checkRequiredEnvironmentVariables();
    if (!allConfigured) {
      log('\n‚ö†Ô∏è  Some Keycloak configuration is missing', 'yellow');
    }
  } else {
    log('\nUsing Mock Authentication (Development Mode)', 'yellow');
    log('To migrate to Keycloak:', 'blue');
    log('1. Configure Keycloak environment variables in .env', 'reset');
    log('2. Run: node scripts/migrate-to-keycloak.js validate', 'reset');
    log('3. Run: node scripts/migrate-to-keycloak.js migrate', 'reset');
  }
}

async function validateConfiguration() {
  logSection('Keycloak Configuration Validation');
  
  const allConfigured = checkRequiredEnvironmentVariables();
  if (!allConfigured) {
    log('\n‚ùå Configuration validation failed', 'red');
    return false;
  }
  
  const keycloakAccessible = await checkKeycloakStatus();
  if (!keycloakAccessible) {
    log('\n‚ùå Keycloak accessibility check failed', 'red');
    log('\nTo fix this issue:', 'blue');
    log('1. Ensure Keycloak is running: ./keycloak-init/start-keycloak.sh start', 'reset');
    log('2. Verify KEYCLOAK_BASE_URL is correct', 'reset');
    log('3. Check that the vendorgrid realm exists', 'reset');
    return false;
  }
  
  log('\n‚úÖ All validation checks passed!', 'green');
  log('Keycloak is properly configured and accessible', 'green');
  return true;
}

async function migrateToKeycloak() {
  logSection('Migrating to Keycloak Authentication');
  
  // Create backup
  const backupPath = createEnvironmentBackup();
  
  // Validate configuration
  const isValid = await validateConfiguration();
  if (!isValid) {
    log('\n‚ùå Migration aborted - configuration validation failed', 'red');
    log('\nTo complete the migration:', 'blue');
    log('1. Configure all required Keycloak environment variables', 'reset');
    log('2. Ensure Keycloak is running and accessible', 'reset');
    log('3. Run this script again with "migrate" command', 'reset');
    return;
  }
  
  // Perform migration
  const currentProvider = getCurrentAuthProvider();
  if (currentProvider === 'keycloak') {
    log('‚ö†Ô∏è  Authentication is already set to Keycloak', 'yellow');
  } else {
    setAuthProvider('keycloak');
  }
  
  log('\nüéâ Migration to Keycloak completed successfully!', 'green');
  log('\nNext steps:', 'blue');
  log('1. Test the authentication flow: Visit /api/auth/status', 'reset');
  log('2. Access the application and verify login works', 'reset');
  log('3. Monitor the application logs for any issues', 'reset');
  
  if (backupPath) {
    log('\nüìÅ Backup created at:', 'blue');
    log(`   ${backupPath}`, 'reset');
    log('This backup can be used to rollback if needed.', 'reset');
  }
}

function rollbackToMock() {
  logSection('Rolling Back to Mock Authentication');
  
  const currentProvider = getCurrentAuthProvider();
  if (currentProvider === 'mock') {
    log('‚ö†Ô∏è  Authentication is already set to mock', 'yellow');
  } else {
    setAuthProvider('mock');
    log('‚úÖ Rolled back to mock authentication', 'green');
  }
  
  log('\nRollback completed successfully!', 'green');
  log('Mock authentication is now active.', 'green');
}

function showHelp() {
  log('VendorGrid Phase 3: Keycloak Migration Script', 'blue');
  log('==============================================\n', 'blue');
  
  log('Usage: node scripts/migrate-to-keycloak.js [command]', 'yellow');
  log('\nCommands:', 'blue');
  log('  status     - Check current authentication status and configuration', 'reset');
  log('  validate   - Validate Keycloak configuration and connectivity', 'reset');
  log('  migrate    - Migrate from mock to Keycloak authentication', 'reset');
  log('  rollback   - Rollback from Keycloak to mock authentication', 'reset');
  log('  help       - Show this help message', 'reset');
  
  log('\nMigration Flow:', 'blue');
  log('1. Configure Keycloak environment variables in .env file', 'reset');
  log('2. Start Keycloak: ./keycloak-init/start-keycloak.sh start', 'reset');
  log('3. Generate client secrets: ./keycloak-init/start-keycloak.sh secrets', 'reset');
  log('4. Update .env with generated secrets', 'reset');
  log('5. Validate: node scripts/migrate-to-keycloak.js validate', 'reset');
  log('6. Migrate: node scripts/migrate-to-keycloak.js migrate', 'reset');
  log('7. Test: Visit /api/auth/status to verify', 'reset');
  
  log('\nRollback:', 'blue');
  log('  node scripts/migrate-to-keycloak.js rollback', 'reset');
}

// Main execution
async function main() {
  const command = process.argv[2] || 'help';
  
  switch (command) {
    case 'status':
      showStatus();
      break;
    case 'validate':
      await validateConfiguration();
      break;
    case 'migrate':
      await migrateToKeycloak();
      break;
    case 'rollback':
      rollbackToMock();
      break;
    case 'help':
    case '--help':
    case '-h':
      showHelp();
      break;
    default:
      log(`‚ùå Unknown command: ${command}`, 'red');
      showHelp();
      process.exit(1);
  }
}

// Run if called directly
if (import.meta.url === `file://${process.argv[1]}`) {
  main().catch(error => {
    log(`‚ùå Script failed: ${error.message}`, 'red');
    process.exit(1);
  });
}

export {
  showStatus,
  validateConfiguration,
  migrateToKeycloak,
  rollbackToMock,
  getCurrentAuthProvider
};