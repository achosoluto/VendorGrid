<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vendor Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">
                <i class="fas fa-building text-blue-600 mr-3"></i>Vendor Management System
            </h1>
            <p class="text-gray-600 text-lg">Manage your vendor database with comprehensive CRUD operations and CSV import/export</p>
        </div>

        <!-- Import/Export Buttons -->
        <div class="mb-6 flex flex-wrap gap-4">
            <button id="exportCsvBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center">
                <i class="fas fa-download mr-2"></i>Export CSV
            </button>
            <label class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors cursor-pointer flex items-center">
                <i class="fas fa-upload mr-2"></i>Import CSV
                <input type="file" id="csvImport" accept=".csv" class="hidden">
            </label>
        </div>

        <!-- Create/Edit Vendor Form -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 border border-gray-100">
            <h2 class="text-xl font-semibold mb-6 text-gray-800 flex items-center">
                <i class="fas fa-plus-circle text-blue-600 mr-3"></i>
                <span id="formTitle">Add New Vendor</span>
            </h2>
            <form id="vendorForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <input type="hidden" id="vendorId" name="id">
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Vendor Name *</label>
                    <input type="text" id="name" name="name" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                </div>
                <div>
                    <label for="tax_id" class="block text-sm font-medium text-gray-700 mb-2">Tax ID (GST/HST) *</label>
                    <input type="text" id="tax_id" name="tax_id" required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                </div>
                <div class="md:col-span-2">
                    <label for="address" class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                    <textarea id="address" name="address" rows="3"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors resize-vertical"></textarea>
                </div>
                <div class="md:col-span-2">
                    <label for="contact_email" class="block text-sm font-medium text-gray-700 mb-2">Contact Email</label>
                    <input type="email" id="contact_email" name="contact_email"
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                </div>
                <div class="md:col-span-2 flex gap-4">
                    <button type="submit" id="submitBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-medium transition-colors flex items-center">
                        <i class="fas fa-save mr-2"></i>Create Vendor
                    </button>
                    <button type="button" id="cancelBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors hidden">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                </div>
            </form>
        </div>

        <!-- Search and Filters -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 border border-gray-100">
            <h3 class="text-lg font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fas fa-search text-green-600 mr-2"></i>Search & Filter Vendors
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div>
                    <label for="searchName" class="block text-sm font-medium text-gray-700 mb-2">Vendor Name</label>
                    <input type="text" id="searchName" placeholder="Search by name..."
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
                </div>
                <div>
                    <label for="searchTaxId" class="block text-sm font-medium text-gray-700 mb-2">Tax ID</label>
                    <input type="text" id="searchTaxId" placeholder="Search by tax ID..."
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
                </div>
                <div>
                    <label for="searchAddress" class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                    <input type="text" id="searchAddress" placeholder="Search by address..."
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
                </div>
                <div>
                    <label for="searchEmail" class="block text-sm font-medium text-gray-700 mb-2">Contact Email</label>
                    <input type="text" id="searchEmail" placeholder="Search by email..."
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-colors">
                </div>
            </div>
            <div class="flex flex-wrap gap-4">
                <button id="searchBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                    <i class="fas fa-search mr-2"></i>Search
                </button>
                <button id="clearSearchBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                    <i class="fas fa-times mr-2"></i>Clear Search
                </button>
                <div class="flex items-center gap-2 ml-auto">
                    <label for="pageSize" class="text-sm font-medium text-gray-700">Show:</label>
                    <select id="pageSize" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span class="text-sm text-gray-700">per page</span>
                </div>
            </div>
        </div>

        <!-- Vendors Table -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100">
            <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-table text-purple-600 mr-3"></i>Vendor Management
                    </h2>
                    <div class="flex gap-3">
                        <button id="refreshBtn" onclick="loadVendors()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-sync-alt mr-2"></i>Refresh
                        </button>
                        <button id="addVendorBtn" onclick="resetForm()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add Vendor
                        </button>
                    </div>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vendor Details</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tax ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Updated</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="vendorsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Vendor rows will be inserted here via JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="paginationControls" class="px-6 py-4 bg-gray-50 border-t border-gray-100" style="display: none;">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span id="paginationInfo" class="text-sm text-gray-700"></span>
                    </div>
                    <div class="flex gap-2">
                        <button id="prevBtn" class="px-3 py-1 text-sm bg-white border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50" disabled>
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="pageNumbers" class="flex gap-1"></span>
                        <button id="nextBtn" class="px-3 py-1 text-sm bg-white border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-50" disabled>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentPage = 1;
        let currentPageSize = 25;
        let searchFilters = {
            name: '',
            tax_id: '',
            address: '',
            contact_email: ''
        };

        // Load vendors with search and pagination
        async function loadVendors(page = 1, pageSize = currentPageSize, filters = {}) {
            try {
                const params = new URLSearchParams({
                    page: page,
                    page_size: pageSize,
                    ...filters
                });

                // Filter out empty values
                Object.keys(params).forEach(key => {
                    if (!params.get(key)) params.delete(key);
                });

                const response = await fetch(`/api/vendors/search?${params}`);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || 'Failed to load vendors');
                }

                displayVendors(result.items || []);
                updatePagination(result);

            } catch (error) {
                console.error('Error loading vendors:', error);
                showAlert('Error loading vendors. Please try again.', 'error');
                displayVendors([]);
            }
        }

        // Display vendors in table
        function displayVendors(vendors) {
            const tbody = document.getElementById('vendorsTableBody');

            if (vendors.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-12 text-center">
                            <i class="fas fa-inbox text-4xl text-gray-300 mb-4"></i>
                            <p class="text-gray-500">No vendors found. Add your first vendor above.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = vendors.map(vendor => `
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 w-10 h-10">
                                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                                    <span class="text-white font-semibold text-sm">${vendor.name.charAt(0).toUpperCase()}</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${vendor.name}</div>
                                ${vendor.address ? `<div class="text-sm text-gray-500"><i class="fas fa-map-marker-alt mr-1"></i>${vendor.address}</div>` : ''}
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900 font-mono">
                            <i class="fas fa-id-card mr-1 text-green-600"></i>${vendor.tax_id}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">
                            ${vendor.contact_email ? `<i class="fas fa-envelope mr-1 text-blue-600"></i>${vendor.contact_email}` : '<span class="text-gray-400">No email</span>'}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(vendor.updated_at).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editVendor(${vendor.id})"
                                class="text-indigo-600 hover:text-indigo-900 mr-4 transition-colors"
                                title="Edit vendor">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteVendor(${vendor.id})"
                                class="text-red-600 hover:text-red-900 transition-colors"
                                title="Delete vendor">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Update pagination controls
        function updatePagination(result) {
            const paginationControls = document.getElementById('paginationControls');
            const pageInfo = document.getElementById('paginationInfo');
            const pageNumbers = document.getElementById('pageNumbers');

            if (result.total_pages <= 1) {
                paginationControls.style.display = 'none';
                return;
            }

            paginationControls.style.display = 'block';
            pageInfo.textContent = `Showing ${((result.page - 1) * result.page_size) + 1}-${Math.min(result.page * result.page_size, result.total)} of ${result.total} vendors`;

            // Update navigation buttons
            document.getElementById('prevBtn').disabled = result.page <= 1;
            document.getElementById('nextBtn').disabled = result.page >= result.total_pages;

            // Render page numbers
            pageNumbers.innerHTML = '';
            const startPage = Math.max(1, result.page - 2);
            const endPage = Math.min(result.total_pages, result.page + 2);

            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.textContent = i;
                btn.className = `px-3 py-1 text-sm rounded transition-colors ${i === result.page ? 'bg-blue-600 text-white' : 'bg-white border border-gray-300 hover:bg-gray-50'}`;
                btn.onclick = () => loadVendors(i, currentPageSize, searchFilters);
                pageNumbers.appendChild(btn);
            }
        }

        // Handle form submission (create/update)
        document.getElementById('vendorForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const vendorData = Object.fromEntries(formData);
            const vendorId = vendorData.id || null;

            // Remove empty fields and id from data
            Object.keys(vendorData).forEach(key => {
                if (vendorData[key] === '') delete vendorData[key];
            });
            delete vendorData.id;

            try {
                const method = vendorId ? 'PUT' : 'POST';
                const url = vendorId ? `/api/vendors/${vendorId}` : '/api/vendors';
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(vendorData)
                });

                if (response.ok) {
                    resetForm();
                    loadVendors();
                    showAlert(`Vendor ${vendorId ? 'updated' : 'created'} successfully!`, 'success');
                } else {
                    const error = await response.json();
                    showAlert(error.detail || `Error ${vendorId ? 'updating' : 'creating'} vendor`, 'error');
                }
            } catch (error) {
                console.error('Error saving vendor:', error);
                showAlert(`Error ${vendorId ? 'updating' : 'creating'} vendor. Please try again.`, 'error');
            }
        });

        // Reset form to create mode
        function resetForm() {
            const form = document.getElementById('vendorForm');
            form.reset();
            document.getElementById('vendorId').value = '';
            document.getElementById('formTitle').textContent = 'Add New Vendor';
            document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save mr-2"></i>Create Vendor';
            document.getElementById('cancelBtn').classList.add('hidden');
            form.scrollIntoView({ behavior: 'smooth' });
        }

        // Cancel editing - reset form
        document.getElementById('cancelBtn').addEventListener('click', resetForm);

        // Edit vendor - load data into form
        async function editVendor(id) {
            try {
                const response = await fetch(`/api/vendors/${id}`);
                if (!response.ok) throw new Error('Failed to load vendor');

                const vendor = await response.json();

                // Populate form with vendor data
                document.getElementById('vendorId').value = vendor.id;
                document.getElementById('name').value = vendor.name;
                document.getElementById('tax_id').value = vendor.tax_id;
                document.getElementById('address').value = vendor.address || '';
                document.getElementById('contact_email').value = vendor.contact_email || '';

                // Update form UI for editing
                document.getElementById('formTitle').textContent = 'Edit Vendor';
                document.getElementById('submitBtn').innerHTML = '<i class="fas fa-save mr-2"></i>Update Vendor';
                document.getElementById('cancelBtn').classList.remove('hidden');

                // Scroll to form
                document.getElementById('vendorForm').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Error loading vendor:', error);
                showAlert('Error loading vendor details.', 'error');
            }
        }

        // Delete vendor
        async function deleteVendor(id) {
            if (!confirm('Are you sure you want to delete this vendor? This action cannot be undone.')) return;

            try {
                const response = await fetch(`/api/vendors/${id}`, { method: 'DELETE' });

                if (response.ok) {
                    loadVendors(currentPage, currentPageSize, searchFilters);
                    showAlert('Vendor deleted successfully!', 'success');
                } else {
                    const error = await response.json();
                    showAlert(error.detail || 'Error deleting vendor.', 'error');
                }
            } catch (error) {
                console.error('Error deleting vendor:', error);
                showAlert('Error deleting vendor. Please try again.', 'error');
            }
        }

        // Search functionality
        document.getElementById('searchBtn').addEventListener('click', () => {
            searchFilters = {
                name: document.getElementById('searchName').value.trim(),
                tax_id: document.getElementById('searchTaxId').value.trim(),
                address: document.getElementById('searchAddress').value.trim(),
                contact_email: document.getElementById('searchEmail').value.trim()
            };
            currentPage = 1; // Reset to first page
            loadVendors(1, currentPageSize, searchFilters);
        });

        // Clear search
        document.getElementById('clearSearchBtn').addEventListener('click', () => {
            document.getElementById('searchName').value = '';
            document.getElementById('searchTaxId').value = '';
            document.getElementById('searchAddress').value = '';
            document.getElementById('searchEmail').value = '';
            searchFilters = {};
            currentPage = 1;
            loadVendors(1, currentPageSize, {});
        });

        // Page size change
        document.getElementById('pageSize').addEventListener('change', (e) => {
            currentPageSize = parseInt(e.target.value);
            currentPage = 1;
            loadVendors(1, currentPageSize, searchFilters);
        });

        // Pagination controls
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentPage > 1) {
                loadVendors(currentPage - 1, currentPageSize, searchFilters);
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            loadVendors(currentPage + 1, currentPageSize, searchFilters);
        });

        // CSV Export
        document.getElementById('exportCsvBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/vendors/export');
                if (!response.ok) throw new Error('Export failed');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'vendors.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showAlert('CSV export completed successfully!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showAlert('Error exporting CSV. Please try again.', 'error');
            }
        });

        // CSV Import
        document.getElementById('csvImport').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/vendors/import', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    let message = `Import completed. ${result.success_count} vendors added successfully.`;
                    if (result.error_count > 0) {
                        message += ` ${result.error_count} errors occurred.`;
                    }
                    showAlert(message, result.error_count > 0 ? 'warning' : 'success');
                    loadVendors(currentPage, currentPageSize, searchFilters);
                } else {
                    showAlert(result.detail || 'Import failed', 'error');
                }
            } catch (error) {
                console.error('Import error:', error);
                showAlert('Error importing CSV. Please try again.', 'error');
            }

            // Reset file input
            e.target.value = '';
        });

        // Enhanced alert system
        function showAlert(message, type = 'info') {
            const alertColors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 shadow-lg transform transition-all duration-300 ${alertColors[type] || alertColors.info}`;

            const icon = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };

            alertDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="${icon[type] || 'fas fa-info-circle'} mr-2"></i>
                    <span class="text-sm font-medium">${message}</span>
                </div>
            `;

            document.body.appendChild(alertDiv);

            // Animate in
            setTimeout(() => alertDiv.classList.add('translate-x-0'), 100);

            // Auto remove after 5 seconds
            setTimeout(() => {
                alertDiv.classList.add('-translate-x-full', 'opacity-0');
                setTimeout(() => alertDiv.remove(), 300);
            }, 5000);
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            loadVendors();
            setupKeyboardShortcuts();
        });

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + Enter to submit form
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    const activeForm = document.activeElement.closest('form');
                    if (activeForm) {
                        activeForm.dispatchEvent(new Event('submit'));
                    }
                }

                // Escape to cancel editing
                if (e.key === 'Escape') {
                    const cancelBtn = document.getElementById('cancelBtn');
                    if (!cancelBtn.classList.contains('hidden')) {
                        resetForm();
                    }
                }
            });
        }
    </script>
</body>
</html>